var countryMapping=[];
countryMapping.push({name:'AF',code:'AFGHANISTAN'});
countryMapping.push({name:'ZA',code:'AFRIQUE DU SUD'});
countryMapping.push({name:'AX',code:'ALAND, ILES'});
countryMapping.push({name:'AL',code:'ALBANIE'});
countryMapping.push({name:'DZ',code:'ALGERIE'});
countryMapping.push({name:'DE',code:'ALLEMAGNE'});
countryMapping.push({name:'AD',code:'ANDORRE'});
countryMapping.push({name:'AO',code:'ANGOLA'});
countryMapping.push({name:'AI',code:'ANGUILLA'});
countryMapping.push({name:'AQ',code:'ANTARCTIQUE'});
countryMapping.push({name:'AG',code:'ANTIGUA ET BARBUDA'});
countryMapping.push({name:'SA',code:'ARABIE SAOUDITE'});
countryMapping.push({name:'AR',code:'ARGENTINE'});
countryMapping.push({name:'AM',code:'ARMENIE'});
countryMapping.push({name:'AW',code:'ARUBA'});
countryMapping.push({name:'AU',code:'AUSTRALIE'});
countryMapping.push({name:'AT',code:'AUTRICHE'});
countryMapping.push({name:'AZ',code:'AZERBAIDJAN'});
countryMapping.push({name:'BS',code:'BAHAMAS'});
countryMapping.push({name:'BH',code:'BAHREIN'});
countryMapping.push({name:'BD',code:'BANGLADESH'});
countryMapping.push({name:'BB',code:'BARBADE'});
countryMapping.push({name:'BY',code:'BELARUS'});
countryMapping.push({name:'BE',code:'BELGIQUE'});
countryMapping.push({name:'BZ',code:'BELIZE'});
countryMapping.push({name:'BJ',code:'BENIN'});
countryMapping.push({name:'BM',code:'BERMUDES'});
countryMapping.push({name:'BT',code:'BHOUTAN'});
countryMapping.push({code:'BOLIVIE',name:'BO'});
countryMapping.push({name:'BA',code:'BOSNIE-HERZEGOVINE'});
countryMapping.push({name:'BW',code:'BOTSWANA'});
countryMapping.push({name:'BV',code:'BOUVET, ILE'});
countryMapping.push({name:'BR',code:'BRESIL'});
countryMapping.push({name:'BN',code:'BRUNEI DARUSSALAM'});
countryMapping.push({name:'BG',code:'BULGARIE'});
countryMapping.push({name:'BF',code:'BURKINA FASO'});
countryMapping.push({name:'BI',code:'BURUNDI'});
countryMapping.push({name:'KY',code:'CAIMANES, ILES'});
countryMapping.push({name:'KH',code:'CAMBODGE'});
countryMapping.push({name:'CM',code:'CAMEROUN'});
countryMapping.push({name:'CA',code:'CANADA'});
countryMapping.push({name:'CV',code:'CAP-VERT'});
countryMapping.push({name:'CF',code:'CENTRAFRICAINE, REPUBLIQUE'});
countryMapping.push({name:'CL',code:'CHILI'});
countryMapping.push({name:'CN',code:'CHINE'});
countryMapping.push({name:'CX',code:'CHRISTMAS, ILE'});
countryMapping.push({name:'CY',code:'CHYPRE'});
countryMapping.push({name:'CC',code:'COCOS (KEELING), ILES'});
countryMapping.push({name:'CO',code:'COLOMBIE'});
countryMapping.push({name:'KM',code:'COMORES'});
countryMapping.push({name:'CG',code:'CONGO'});
countryMapping.push({name:'CD',code:'CONGO, LA REPUBLIQUE DEMOCRATIQUE DU'});
countryMapping.push({name:'CK',code:'COOK, ILES'});
countryMapping.push({name:'KR',code:'COREE, REPUBLIQUE DE'});
countryMapping.push({name:'KP',code:'COREE, REPUBLIQUE POPULAIRE DEMOCRATIQUE DE'});
countryMapping.push({name:'CR',code:'COSTA RICA'});
countryMapping.push({name:'CI',code:'COTE D IVOIRE'});
countryMapping.push({name:'HR',code:'CROATIE'});
countryMapping.push({name:'CU',code:'CUBA'});
countryMapping.push({name:'CW',code:'CURACAO'});
countryMapping.push({name:'DK',code:'DANEMARK'});
countryMapping.push({name:'DJ',code:'DJIBOUTI'});
countryMapping.push({name:'DO',code:'DOMINICAINE, REPUBLIQUE'});
countryMapping.push({name:'DM',code:'DOMINIQUE'});
countryMapping.push({name:'EG',code:'EGYPTE'});
countryMapping.push({name:'SV',code:'EL SALVADOR'});
countryMapping.push({name:'AE',code:'EMIRATS ARABES UNIS'});
countryMapping.push({name:'EC',code:'EQUATEUR'});
countryMapping.push({name:'ER',code:'ERYTHREE'});
countryMapping.push({name:'ES',code:'ESPAGNE'});
countryMapping.push({name:'EE',code:'ESTONIE'});
countryMapping.push({name:'US',code:'ETATS-UNIS'});
countryMapping.push({name:'ET',code:'ETHIOPIE'});
countryMapping.push({name:'FK',code:'FALKLAND, ILES (MALVINAS)'});
countryMapping.push({name:'FO',code:'FEROE, ILES'});
countryMapping.push({name:'FJ',code:'FIDJI'});
countryMapping.push({name:'FI',code:'FINLANDE'});
countryMapping.push({name:'FR',code:'FRANCE'});
countryMapping.push({name:'GA',code:'GABON'});
countryMapping.push({name:'GM',code:'GAMBIE'});
countryMapping.push({name:'GE',code:'GEORGIE'});
countryMapping.push({name:'GS',code:'GEORGIE DU SUD ET LES ILES SANDWICH DU SUD'});
countryMapping.push({name:'GH',code:'GHANA'});
countryMapping.push({name:'GI',code:'GIBRALTAR'});
countryMapping.push({name:'GR',code:'GRECE'});
countryMapping.push({name:'GD',code:'GRENADE'});
countryMapping.push({name:'GL',code:'GROENLAND'});
countryMapping.push({name:'GP',code:'GUADELOUPE'});
countryMapping.push({name:'GU',code:'GUAM'});
countryMapping.push({name:'GT',code:'GUATEMALA'});
countryMapping.push({name:'GG',code:'GUERNESEY'});
countryMapping.push({name:'GN',code:'GUINEE'});
countryMapping.push({name:'GW',code:'GUINEE-BISSAU'});
countryMapping.push({name:'GQ',code:'GUINEE EQUATORIALE'});
countryMapping.push({name:'GY',code:'GUYANA'});
countryMapping.push({name:'GF',code:'GUYANE FRANCAISE'});
countryMapping.push({name:'HT',code:'HAITI'});
countryMapping.push({name:'HM',code:'HEARD, ILE ET MCDONALD, ILES'});
countryMapping.push({name:'HN',code:'HONDURAS'});
countryMapping.push({name:'HK',code:'HONG KONG'});
countryMapping.push({name:'HU',code:'HONGRIE'});
countryMapping.push({name:'IM',code:'ILE DE MAN'});
countryMapping.push({name:'UM',code:'ILES MINEURES ELOIGNEES DES ETATS-UNIS'});
countryMapping.push({name:'VG',code:'ILES VIERGES BRITANNIQUES'});
countryMapping.push({name:'VI',code:'ILES VIERGES DES ETATS-UNIS'});
countryMapping.push({name:'IN',code:'INDE'});
countryMapping.push({name:'ID',code:'INDONESIE'});
countryMapping.push({name:'IR',code:'IRAN, REPUBLIQUE ISLAMIQUE D'});
countryMapping.push({name:'IQ',code:'IRAQ'});
countryMapping.push({name:'IE',code:'IRLANDE'});
countryMapping.push({name:'IS',code:'ISLANDE'});
countryMapping.push({name:'IL',code:'ISRAEL'});
countryMapping.push({name:'IT',code:'ITALIE'});
countryMapping.push({name:'JM',code:'JAMAIQUE'});
countryMapping.push({name:'JP',code:'JAPON'});
countryMapping.push({name:'JE',code:'JERSEY'});
countryMapping.push({name:'JO',code:'JORDANIE'});
countryMapping.push({name:'KZ',code:'KAZAKHSTAN'});
countryMapping.push({name:'KE',code:'KENYA'});
countryMapping.push({name:'KG',code:'KIRGHIZISTAN'});
countryMapping.push({name:'KI',code:'KIRIBATI'});
countryMapping.push({name:'KW',code:'KOWEIT'});
countryMapping.push({name:'LA',code:'LAO, REPUBLIQUE DEMOCRATIQUE POPULAIRE'});
countryMapping.push({name:'LS',code:'LESOTHO'});
countryMapping.push({name:'LV',code:'LETTONIE'});
countryMapping.push({name:'LB',code:'LIBAN'});
countryMapping.push({name:'LR',code:'LIBERIA'});
countryMapping.push({name:'LY',code:'LIBYENNE, JAMAHIRIYA ARABE'});
countryMapping.push({name:'LI',code:'LIECHTENSTEIN'});
countryMapping.push({name:'LT',code:'LITUANIE'});
countryMapping.push({name:'LU',code:'LUXEMBOURG'});
countryMapping.push({name:'MO',code:'MACAO'});
countryMapping.push({name:'MK',code:'MACEDOINE, L EX-REPUBLIQUE YOUGOSLAVE DE'});
countryMapping.push({name:'MG',code:'MADAGASCAR'});
countryMapping.push({name:'MY',code:'MALAISIE'});
countryMapping.push({name:'MW',code:'MALAWI'});
countryMapping.push({name:'MV',code:'MALDIVES'});
countryMapping.push({name:'ML',code:'MALI'});
countryMapping.push({name:'MT',code:'MALTE'});
countryMapping.push({name:'MP',code:'MARIANNES DU NORD, ILES'});
countryMapping.push({name:'MA',code:'MAROC'});
countryMapping.push({name:'MH',code:'MARSHALL, ILES'});
countryMapping.push({name:'MQ',code:'MARTINIQUE'});
countryMapping.push({name:'MU',code:'MAURICE'});
countryMapping.push({name:'MR',code:'MAURITANIE'});
countryMapping.push({name:'YT',code:'MAYOTTE'});
countryMapping.push({name:'MX',code:'MEXIQUE'});
countryMapping.push({name:'FM',code:'MICRONESIE, ETATS FEDERES DE'});
countryMapping.push({name:'MD',code:'MOLDOVA, REPUBLIQUE DE'});
countryMapping.push({name:'MC',code:'MONACO'});
countryMapping.push({name:'MN',code:'MONGOLIE'});
countryMapping.push({name:'ME',code:'MONTENEGRO'});
countryMapping.push({name:'MS',code:'MONTSERRAT'});
countryMapping.push({name:'MZ',code:'MOZAMBIQUE'});
countryMapping.push({name:'MM',code:'MYANMAR'});
countryMapping.push({name:'NA',code:'NAMIBIE'});
countryMapping.push({name:'NR',code:'NAURU'});
countryMapping.push({name:'NP',code:'NEPAL'});
countryMapping.push({name:'NI',code:'NICARAGUA'});
countryMapping.push({name:'NE',code:'NIGER'});
countryMapping.push({name:'NG',code:'NIGERIA'});
countryMapping.push({name:'NU',code:'NIUE'});
countryMapping.push({name:'NF',code:'NORFOLK, ILE'});
countryMapping.push({name:'NO',code:'NORVEGE'});
countryMapping.push({name:'NC',code:'NOUVELLE-CALEDONIE'});
countryMapping.push({name:'NZ',code:'NOUVELLE-ZELANDE'});
countryMapping.push({name:'IO',code:'OCEAN INDIEN, TERRITOIRE BRITANNIQUE DE L'});
countryMapping.push({name:'OM',code:'OMAN'});
countryMapping.push({name:'UG',code:'OUGANDA'});
countryMapping.push({name:'UZ',code:'OUZBEKISTAN'});
countryMapping.push({name:'PK',code:'PAKISTAN'});
countryMapping.push({name:'PW',code:'PALAOS'});
countryMapping.push({name:'PS',code:'PALESTINIEN OCCUPE, TERRITOIRE'});
countryMapping.push({name:'PA',code:'PANAMA'});
countryMapping.push({name:'PG',code:'PAPOUASIE-NOUVELLE-GUINEE'});
countryMapping.push({name:'PY',code:'PARAGUAY'});
countryMapping.push({name:'NL',code:'PAYS-BAS'});
countryMapping.push({name:'PE',code:'PEROU'});
countryMapping.push({name:'PH',code:'PHILIPPINES'});
countryMapping.push({name:'PN',code:'PITCAIRN'});
countryMapping.push({name:'PL',code:'POLOGNE'});
countryMapping.push({name:'PF',code:'POLYNESIE FRANCAISE'});
countryMapping.push({name:'PR',code:'PORTO RICO'});
countryMapping.push({name:'PT',code:'PORTUGAL'});
countryMapping.push({name:'QA',code:'QATAR'});
countryMapping.push({name:'RE',code:'REUNION'});
countryMapping.push({name:'RO',code:'ROUMANIE'});
countryMapping.push({name:'GB',code:'ROYAUME-UNI'});
countryMapping.push({name:'RU',code:'RUSSIE, FEDERATION DE'});
countryMapping.push({name:'RW',code:'RWANDA'});
countryMapping.push({name:'EH',code:'SAHARA OCCIDENTAL'});
countryMapping.push({name:'BL',code:'SAINT-BARTHELEMY'});
countryMapping.push({name:'SH',code:'SAINTE-HELENE, ASCENSION ET TRISTAN DA CUNHA'});
countryMapping.push({name:'LC',code:'SAINTE-LUCIE'});
countryMapping.push({name:'KN',code:'SAINT-KITTS-ET-NEVIS'});
countryMapping.push({name:'SM',code:'SAINT-MARIN'});
countryMapping.push({name:'MF',code:'SAINT-MARTIN (PARTIE FRANCAISE)'});
countryMapping.push({name:'SX',code:'SAINT-MARTIN (PARTIE NEERLANDAISE)'});
countryMapping.push({name:'PM',code:'SAINT-PIERRE-ET-MIQUELON'});
countryMapping.push({name:'VA',code:'SAINT-SIEGE (ETAT DE LA CITE DU VATICAN)'});
countryMapping.push({name:'VC',code:'SAINT-VINCENT-ET-LES GRENADINES'});
countryMapping.push({name:'SB',code:'SALOMON, ILES'});
countryMapping.push({name:'WS',code:'SAMOA'});
countryMapping.push({name:'AS',code:'SAMOA AMERICAINES'});
countryMapping.push({name:'ST',code:'SAO TOME-ET-PRINCIPE'});
countryMapping.push({name:'SN',code:'SENEGAL'});
countryMapping.push({name:'RS',code:'SERBIE'});
countryMapping.push({name:'SC',code:'SEYCHELLES'});
countryMapping.push({name:'SL',code:'SIERRA LEONE'});
countryMapping.push({name:'SG',code:'SINGAPOUR'});
countryMapping.push({name:'SK',code:'SLOVAQUIE'});
countryMapping.push({name:'SI',code:'SLOVENIE'});
countryMapping.push({name:'SO',code:'SOMALIE'});
countryMapping.push({name:'SD',code:'SOUDAN'});
countryMapping.push({name:'LK',code:'SRI LANKA'});
countryMapping.push({name:'SE',code:'SUEDE'});
countryMapping.push({name:'CH',code:'SUISSE'});
countryMapping.push({name:'SR',code:'SURINAME'});
countryMapping.push({name:'SJ',code:'SVALBARD ET ILE JAN MAYEN'});
countryMapping.push({name:'SZ',code:'SWAZILAND'});
countryMapping.push({name:'SY',code:'SYRIENNE, REPUBLIQUE ARABE'});
countryMapping.push({name:'TJ',code:'TADJIKISTAN'});
countryMapping.push({name:'TW',code:'TAIWAN, PROVINCE DE CHINE'});
countryMapping.push({name:'TZ',code:'TANZANIE, REPUBLIQUE-UNIE DE'});
countryMapping.push({name:'TD',code:'TCHAD'});
countryMapping.push({name:'CZ',code:'TCHEQUE, REPUBLIQUE'});
countryMapping.push({name:'TF',code:'TERRES AUSTRALES FRANCAISES'});
countryMapping.push({name:'TH',code:'THAILANDE'});
countryMapping.push({name:'TL',code:'TIMOR-LESTE'});
countryMapping.push({name:'TG',code:'TOGO'});
countryMapping.push({name:'TK',code:'TOKELAU'});
countryMapping.push({name:'TO',code:'TONGA'});
countryMapping.push({name:'TT',code:'TRINITE-ET-TOBAGO'});
countryMapping.push({name:'TN',code:'TUNISIE'});
countryMapping.push({name:'TM',code:'TURKMENISTAN'});
countryMapping.push({name:'TC',code:'TURKS ET CAIQUES, ILES'});
countryMapping.push({name:'TR',code:'TURQUIE'});
countryMapping.push({name:'TV',code:'TUVALU'});
countryMapping.push({name:'UA',code:'UKRAINE'});
countryMapping.push({name:'UY',code:'URUGUAY'});
countryMapping.push({name:'VU',code:'VANUATU'});
countryMapping.push({name:'vo',code:'VATICAN, ETAT DE LA CITE DU ir SAINT-SIEGE'});
countryMapping.push({name:'VE',code:'VENEZUELA, REPUBLIQUE BOLIVARIENNE DU'});
countryMapping.push({name:'VN',code:'VIET NAM'});
countryMapping.push({name:'WF',code:'WALLIS ET FUTUNA'});
countryMapping.push({name:'YE',code:'YEMEN'});
countryMapping.push({name:'ZM',code:'ZAMBIE'});
countryMapping.push({name:'ZW',code:'ZIMBABWE'});

function makeRandomString(length) {
	var result           = '';
	var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	var charactersLength = characters.length;
	for ( var i = 0; i < length; i++ ) {
	   result += characters.charAt(Math.floor(Math.random() * charactersLength));
	}
	return result;
 }
 

angular.module('delr1', ['angular.img','ngDialog'])
	.controller('GalleryCtrl', function($scope,$rootScope,$http,$timeout,ngDialog) {
		//10 seconds delay
		$scope.timeout=function() {
			$timeout( function(){
				$http.get("/api/v1/getToken")
					.then(function(res){
						token=res.data.token;
						$http.defaults.headers.common = { 'Authorization' : 'Bearer '+token };
						$scope.timeout();
					});	
				
			}, 1200000 );
		};
		$scope.timeout();

		if (token!="")
		{			$http.defaults.headers.common = { 'Authorization' : 'Bearer '+token };

		}

		$scope.alert=function(msg) {
			alert(msg);
		}
		
		$rootScope.$on('ngDialog.opened', function (e, $dialog) {
			$('#inputcomment').focus();
		});


		//************************************************************************
		//* Get images order and send it
		//* 
		//************************************************************************ 
	
		$scope.getIdsOfImages=function() { 
			var values = []; 
			$('.photos').each(function(index) { 
				values.push($(this).attr("id") 
							.replace("photo", "")); 
			}); 
			console.log(values);
			$http.patch('/api/v1/albums/'+$scope.album.id+'/photos/orders',values)
			  .then(function(res) {
					//$scope.photos=res.data;

			  },function(res){
					alert('Warning, error during reordering');
			  });
    	}  

		//************************************************************************
		//* Set or unset public attribute on album
		//* 
		//************************************************************************
		$scope.managePublic = function(action) {
			if ((action==1) && ($scope.album.id_pub==undefined || $scope.album.id_pub==""))
				$scope.album.id_pub = makeRandomString(20);
			$http.patch("/api/v1/albums/"+$scope.album.id,JSON.stringify({'public':action,'idPub':$scope.album.id_pub}))
				.then(function(res) {	
					$scope.album=res.data;
				});
		}

		$scope.zipOpen = function() {
			$scope.zip = ngDialog.open({ template: 'zipid',className: 'ngdialog-theme-default',scope:$scope });
			$timeout( function(){
				$scope.zip.close();
				
			}, 5000 );
		}

		//************************************************************************
		//* Open country selection popup
		//* 
		//************************************************************************   
		$scope.displayCountry = function() {
			ngDialog.open({ template: 'countryselection',className: 'ngdialog-theme-default',scope:$scope });
		}

		//************************************************************************
		//* delete album popup
		//* 
		//************************************************************************   
		$scope.deleteAlbum = function(validation) {
			if (validation!="OK")
				$scope.deleteDialog=ngDialog.open({ template: 'deleteAlbum',className: 'ngdialog-theme-default',scope:$scope });
			else {
				$scope.deleteDialog.close();
				$http.delete("/api/v1/albums/"+$scope.album.id)
					.then(function(res){

						$scope.displayGal();
					});

			}
		}

		//************************************************************************
		//* delete
		//* 
		//************************************************************************
		$scope.deletePhoto = function (index) {
			$http.delete("/api/v1/albums/"+$scope.album.id+"/photos/"+$scope.photos[index].id)
				.then(function(res) {
					$scope.actShowPhoto($scope.album.id);
					ngDialog.close($scope.dialogid);

				});
		}

		//************************************************************************
		//* Show comment on image click 
		//* 
		//************************************************************************
		$scope.showCom = function (id,index) {
			$scope.currentcommentindex=index;
			$scope.currentcomment=$scope.photos[index].commentaire;
			$scope.dialogid=ngDialog.open({ template: 'modalid',className: 'ngdialog-theme-default',scope:$scope });
			
		}

		//************************************************************************
		//* Update comment on photo
		//* 
		//************************************************************************
		$scope.updateComment = function (index,comment) {
			$http.patch("/api/v1/albums/"+$scope.album.id+"/photos/"+$scope.photos[index].id,JSON.stringify({'commentaire': comment}))
				.then(function(res) {
					$scope.photos[index].commentaire=res.data.commentaire;
					ngDialog.close($scope.dialogid);
				});
		}

		
		//************************************************************************
		//* Upload photos 
		//* 
		//************************************************************************
		$scope.uploadOneFile=function (file_obj,album, start,end) {
			if(start>end)
			{
				if($scope.uploadInProgress==0)
					$scope.actShowPhoto(album);
				return;
			}
			$http.post('/api/v1/albums/'+album+'/photos',{'album_id':album})
						.then(function(res) {
							let file = file_obj[start];
							$scope.uploadInProgress++;
							$scope.upload[file.name]='Downloading';
							let photo=res.data;
							let form_data = new FormData();
							form_data.append('file[]', file); 
							$http.post('/api/v1/albums/'+album+'/photos/'+photo.id,form_data,{headers: {
								'Content-Type': undefined
							  },
							  transformRequest: angular.identity
							})
								.then(function (res){
									$scope.upload[file.name]='Downloaded';
									$scope.uploadInProgress--;
									$scope.uploadOneFile(file_obj,album,start+1,end);
								}, function (res) {
									$scope.upload[file.name]='Error';
									$scope.uploadInProgress--;
									console.log(res);
									$http.delete('/api/v1/albums/'+album+'/photos/'+photo.id);
									$scope.uploadOneFile(file_obj,album,start+1,end);
								}
								);
						});

		};



		$scope.manageFileUpload = function(file_obj) {
			if(file_obj != undefined) {
				$scope.saveInfo(false);
				let album = $scope.album.id;
				uploadPopup=ngDialog.open({ 
					template: 'uploadid',
					
					scope:$scope,
					//closeByDocument:false,
					preCloseCallback: function(value) {
						if ($scope.uploadInProgress==0)
							return true;
						if (confirm('Are you sure you want to close, upload is in progress')) {
							return true;
						}
						return false;
					},
					className: 'ngdialog-theme-default'
				 });
				$scope.uploadInProgress=0;
				$scope.upload={};
				$scope.lockupload=1;
				
				for(let i=0; i<file_obj.length; i++)
					$scope.upload[file_obj[i].name]='waiting';
				
				step=Math.ceil(file_obj.length/5);// 5 upload in parallel max
				let i=0;
				while(i<file_obj.length) {
					let limit = i+step-1;
					if (limit>=file_obj.length)
						limit=file_obj.length-1;
					$scope.uploadOneFile(file_obj,album,i,limit);
					i+=step;
				}
				$('#selectfile').val('');
			}
		};

		$scope.upload_file = function(e) {
			e.preventDefault();
			$scope.manageFileUpload(e.dataTransfer.files);
		};


		//************************************************************************
		//* Upload photos 
		//* 
		//************************************************************************
		$scope.createAlbum = function () {
			var today = new Date();
			var dd = String(today.getDate()).padStart(2, '0');
			var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
			var yyyy = today.getFullYear();

			today = yyyy + '-' + mm + '-' + dd;
			$http.post('/api/v1/albums',{'name':'temp','date':today, 'commentaire':'', 'path':''})
				.then(function(res) {
					$scope.actShowPhoto(res.data.id);
				},
				function(res){
					console.log(res);
					alert("Error creating album : "+res.data.error_str)
				});

		};

		//************************************************************************
		//* User Management
		//* 
		//************************************************************************
		

		// API Request to modify existing user
		$scope.modifyUser=function() {
			let req = {'username':$scope.editUser.username,'isAdmin':$scope.editUser.isAdmin};
			if ($scope.editUser.password!=""){
				req['password']=$scope.editUser.password;
			}
			$http.patch('/api/v1/users/'+$scope.editUser.id,req)
				.then(function(res) {
					$scope.dialogid.close();
					$scope.manageUser();
				},
				function(res){
					alert("Error updating user :(")
				});
		}

		// Load user information in form and display form
		$scope.editOneUser=function(id=-1) {
			$scope.dialogid.close();
			if (id==-1){ // if user creation
				$http.post('/api/v1/users',{'username':'temp'})
				  .then(function(res){
					user = res.data;
					$scope.editOneUser(user.id);
				  });
			} else { // request information about user
				$http.get('/api/v1/users/'+id)
								.then(function(res){
									$scope.editUser = res.data;
									$scope.editUser.isAdmin=false;
									JSON.parse($scope.editUser.roles).forEach(element => {
										if(element=='ROLE_ADMIN')
											$scope.editUser.isAdmin=true;
									});
									$scope.dialogid.close();
									$scope.dialogid=ngDialog.open({ template: 'useredit',className: 'ngdialog-theme-default',scope:$scope });
								});
			}

		}

		$scope.deleteUser = function() {
			$http.delete('/api/v1/users/'+$scope.editUser.id) 
				.then(function(res){
					$scope.dialogid.close();
					$scope.manageUser();
				});

		}
		// Open user management window
		$scope.manageUser = function() {
			$http.get('/api/v1/users')
							.then(function(res){
								$scope.users = res.data;
								$scope.dialogid=ngDialog.open({ template: 'userselection',className: 'ngdialog-theme-default',scope:$scope });
							});

		}


		$scope.albumChanged = function() {
			$scope.albumHasChanged=true;

		};
		//************************************************************************
		//* Click on button save 
		//* 
		//************************************************************************

	    $scope.saveInfo = function(refreshPhoto=true) {
			right2send="";
			if($scope.albumHasChanged===false) {
				$scope.inprogress=0;
				return;
			}
			$scope.inprogress=1;

			// Manage rights
			var u = []
			$scope.rights.forEach(element => {
				if (element.hasRight)
					u.push({ 'id': element.id} )

			});
			$http.post('/api/v1/albums/'+$scope.album.id+'/rights',JSON.stringify(u))
				.then(function(res){
					$scope.showRights($scope.album.id);
				});


			// Manage albums modificaiton
			$http.patch('/api/v1/albums/'+$scope.album.id, 
						{'name':$scope.album.name,'date':$scope.album.date,'commentaire':$scope.album.commentaire,'country':$scope.album.country,'youtube':$scope.album.youtube,'sorter':$scope.album.sorter})
						.then(function(data, status, headers, config) {
							$scope.albumHasChanged=false;
							$scope.inprogress=2;
							$timeout(function () { $scope.inprogress=0 }, 3000);
							if (refreshPhoto) {
								$scope.actShowPhoto($scope.album.id);
							}
						},
						function(data, status, headers, config) {
							alert(data.error);
							$scope.inprogress=0;
						});

			};

		$scope.requestImage = function(url,element) {
			$http.get(url)
				.success(function(res){
					element.src=URL.createObjectURL(res);
					element.onload = () => {
                        URL.revokeObjectURL(element.src);
                    }
				});
		};

		//*************************************************************************
		//* Display Rights (admin panel)
		//* 
		//* Call /api/v1/albums/{idalbum}/rights : get album rights
		//* Call /api/v1/users : get all users
		//* Create list of all users with hasRight=true if user has rights on album
		//*************************************************************************
		$scope.showRights=function(id) {
			$http.get('/api/v1/albums/'+id+'/rights')
					.then(function(res){
						$scope.albumRight = res.data;
						$http.get('/api/v1/users')
							.then(function(res){
								$scope.users = res.data;
								var u = [];
								$scope.users.forEach(element => {
									hasRight=false;
									$scope.albumRight.forEach(r => {
										if (r.idUser==element.id)
											hasRight=true;
									});
									if (element.id!=0)
										u.push({'username': element.username,'id':element.id,'hasRight':hasRight});
								});
								$scope.rights=u;
							});
					});

		}

		//************************************************************************
		//* Display photos 
		//*
		//* Call /api/v1/albums/{albumid} - get Album info
		//* Call /api/v1/albums/{albumid}/photos - get all photos
		//************************************************************************
   	 	$scope.actShowPhoto = function(id) {
			$scope.back=$(window).scrollTop();
	   		$scope.showphoto=true;
			param='';


			if (admin) {
				// Make photos sortable
				$("#photoList").sortable({ 
					update: function(event, ui) { 
							$scope.getIdsOfImages(); 
						}, //end update  
					helper:'clone'
				});

		
				$scope.showRights(id);
			}

			$http.get('/api/v1/albums/'+id)
       				.then(function(res){
						$scope.album = res.data;
						$scope.videotab=$scope.album.youtube.match(/[^\r\n]+/g);
						$http.get('/api/v1/albums/'+id+'/photos')
							.then(function(res){
								$scope.idAlbum=id;
								$scope.photos=res.data;
							});	
						if ($scope.videotab!=null){
							$scope.videotabshow=true;

							var myvideogallery = new ddyoutubeGallery({
									sliderid: 'videojukebox',
									selected: 0, // default selected video within playlist (0=1st, 1=2nd etc)
									autoplay: 0, // 0 to disable auto play, 1 to enable
									autocycle: 1, // 0 to disable auto cycle, 1 to auto cycle and play each video automatically
									playlist: $scope.videotab // list of youtube video IDs. It's the last segment within a shareable Youtube URL
							});
							$("#videojukebox").show();
						}
						else {
							$scope.videotabshow=false;
							$("#videojukebox").hide();
						}
	        		});
				if ($scope.album == undefined)
					return;

				
    	};
		

		//************************************************************************
		//* Center page on video 
		//* 
		//************************************************************************
		$scope.goToVideo = function() {
			$(document).scrollTop($('#videobox').offset().top);
		}

		//************************************************************************
		//* Manage click on album pagging 
		//* 
		//************************************************************************
		$scope.actShowPage = function(page) {
				if (page<$scope.numAlbums)
						$scope.startGal=page;
				$scope.displayGal();
		};

		//************************************************************************
		//* Display video (old school flash player) 
		//* 
		//* TO REMOVE
		//************************************************************************

		$scope.showVideo = function() {
				  $( "#dialog" ).dialog( "open" );

                                  param="/videos.php?";
                                  if (hashgal)
                                        param+='alphanum_hash='+hashgal+'/'+$scope.gallery.gallery.id+'&';
                                  param+='id_gal='+$scope.gallery.gallery.id;
                                  so.addVariable('playlistfile',param);
                                  so.addVariable('file',param);
                                  so.addVariable('frontcolor','000000');
                                  so.addVariable('lightcolor','cc9900');
                                  so.addVariable('screencolor','000000');
                                  so.addVariable('plugins','grid-1');
                                  so.addVariable('dock', 'true');
                                  so.addVariable('skin', '/video/skin/classic.zip');

                                  so.write('mediaspace');


		}
	

		//************************************************************************
		//* Display diaporama 
		//* 
		//************************************************************************
		$scope.diaporama = function() {
			$("#pht0").trigger("click");
			setTimeout(function(){
				$("#fullsized_fullscreen").trigger("click");
				$("#fullsized_play_id").trigger("click");
			}, 1000);
		}

		//************************************************************************
		//* Update album list according to search 
		//* 
		//************************************************************************
		$scope.updatesearch = function(val) {
				if (val.length>2){
					$scope.filter=val;
					$scope.startGal=0;
				} else 
					$scope.filter="";
				$scope.displayGal();
		};


		//************************************************************************
		//* Show album list 
		//* 
		//************************************************************************
		$scope.displayGal = function(){
			$scope.showphoto=false;
					//	$("#polaroid").width(Math.floor($("#polaroid").width() / 260)*260);
					if ($scope.startGal!=0) {
						$page="&page="+btoa(JSON.stringify({"page":$scope.startGal+1,"limit":$scope.galLimit}));
					} else {
						$page='';
					}

					if (admin)
						$page+="&admin=1";

	                $http.get('/api/v1/albums?num_start='+$scope.startGal+$page+'&keyword='+$scope.filter)
        	                .then(function(res){
								$scope.albums = res.data.data;
								$scope.numAlbums = res.data.meta.total_items;
								$scope.link=[];
								i=0;
								
								while(i*$scope.galLimit<$scope.numAlbums)
								{	
									$scope.link.push({indice:i,selected:(i==$scope.startGal)});
									i+=1;
								}			
			                });

		}

		//************************************************************************
		//* Manage click on next page album pagging 
		//* 
		//************************************************************************
		$scope.nextPage=function() {
			$scope.startGal+=1;
			if($scope.startGal*$scope.galLimit>$scope.numAlbums)
				$scope.startGal = $scope.startGal-1;
			$scope.displayGal();
		}

		//************************************************************************
		//* Manage click on previous page album pagging 
		//* 
		//************************************************************************
		$scope.previousPage=function() {
				$scope.startGal-=1;
				if ($scope.startGal<0)
						$scope.startGal=0;
				$scope.displayGal();
		}


		//************************************************************************
		//* Manage click on back button 
		//* 
		//************************************************************************
		$scope.returnToGal = function () {
			idgal=false;
			$(window).scrollTop($scope.back);
			$scope.showphoto=false;
			$scope.hash="";
			$scope.displayGal();
		}




		//************************************************************************
		//* Manage jquery.fullsizable 
		//* 
		//************************************************************************
		$scope.$on('ngRepeatFinished', function (ngRepeatFinishedEvent) {
			if ($scope.showphoto){
				$('#fullsized_go_next').off('click')
        			$('#fullsized_go_prev').off('click')
				$('a.fullsizable').fullsizable({
				detach_id: 'phctrl',
				clickBehaviour: 'next',
				closeButton: true,
                downloadLink: true,
				navigation: true,
				openOnClick: true,
				reloadOnOpen: false
      				});
				window.scrollTo(0,0);
				$scope.$broadcast('scroll.scrollTop')
			}
	
		});


		//************************************************************************
		//* Init 
		//* 
		//************************************************************************
		$scope.tokenAlbum = hashgal;
		$scope.startGal=0;
		$scope.galLimit=30;
		$scope.numGal=0;
		$scope.gallery={};
		$scope.link=[];
		$scope.filter="";
		$scope.baseUrl=baseURL;
		$scope.countryMapping = countryMapping;
		$scope.token=token;
		$scope.albumHasChanged=false;

		
		var zt = new ZingTouch.Region(document.body,false,false);
		var myElement = document.getElementById('polaroid');
		zt.bind(myElement, 'swipe', function(e){
			//Actions here
			direction = Math.floor(e.detail.data[0].currentDirection);
			if (direction<45 || direction>315)
				$scope.previousPage();
			if (direction>135 && direction<205)
				$scope.nextPage();
		}, true);


		$( "#datepicker" ).datepicker({
			dateFormat: 'yy-mm-dd',
			showOtherMonths: true,
			showButtonPanel: true,
			changeMonth: true,
			changeYear: true,
			autocloe:false,
			selectOtherMonths: true,
			onClose:function(date,obj){ $scope.album.date=date}
		  });

		if (idgal) {
            $scope.showphoto=true;
			$scope.hash=hashgal;
			$scope.actShowPhoto(idgal);
		}
		else {
			$scope.showphoto=false;
            $scope.displayGal();			
		}
	})

	.directive('onFinishRenderFilters', function ($timeout) {
		return {
			restrict: 'A',
			link: function (scope, element, attr) {
				if (scope.$last === true) {
					$timeout(function () {
						scope.$emit('ngRepeatFinished');
					});
				}
			}
		}
	});





	
